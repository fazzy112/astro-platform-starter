---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main class="min-h-screen flex flex-col items-center justify-center text-center bg-gradient-to-br from-blue-50 to-white px-4">
    <!-- Processing Spinner -->
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-600 border-opacity-50 mb-6"></div>
    <h1 class="text-3xl font-semibold text-blue-800 mb-2">Generating Your Resume...</h1>
    <p class="text-gray-600 mb-6">Please wait a few seconds while our AI builds your resume, cover letter, and calculates your score.</p>

    <!-- Optional Loading Tips -->
    <ul class="text-gray-500 text-sm space-y-1">
      <li>✔️ Tailoring your resume for the job description...</li>
      <li>✔️ Writing your personalized cover letter...</li>
      <li>✔️ Scoring your resume for strengths & improvements...</li>
    </ul>
  </main>

  <!-- Auto-Redirect Script -->
  <script>
    // Simulate loading and fetch data from localStorage to send to your workflow
    setTimeout(() => {
      const data = JSON.parse(localStorage.getItem("resumeFormData"));
      if (!data) return alert("No form data found. Please go back and try again.");

      const query = new URLSearchParams({
        firstName: data.firstName || "",
        lastName: data.lastName || "",
        email: data.email || "",
        phone: data.phone || "",
        education: data.education || "",
        experience: data.experience || "",
        skills: data.skills || "",
        objective: data.objective || ""
      });

      // Send data to n8n webhook
      fetch("https://n8n.YOUR_DOMAIN_OR_HOSTNAME/webhook/your_workflow_path", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(Object.fromEntries(query)),
      })
        .then(res => res.json())
        .then(response => {
          const { resume, coverLetter, score, strengths, improvements } = response;
          // Store results in localStorage
          localStorage.setItem("aiResumeResult", JSON.stringify({ resume, coverLetter, score, strengths, improvements }));
          window.location.href = "/score";
        })
        .catch(error => {
          console.error("Failed to fetch resume:", error);
          alert("There was an error generating your resume. Please try again.");
        });
    }, 3000);
  </script>
</Layout>
